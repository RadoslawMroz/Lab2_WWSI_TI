<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Sklep â€“ Lab 02</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header><h1>ðŸ›’ Sklep â€“ Lab 02</h1></header>

  <main>
    <section class="panel">
      <h2>Produkty</h2>
      <ul id="products"></ul>
    </section>

    <section class="panel">
      <h2>Koszyk</h2>
      <table id="cartTable">
        <thead>
          <tr>
            <th>Produkt</th><th>Cena</th><th>IloÅ›Ä‡</th><th>UsuÅ„</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>

      <p id="cartTotal"></p>
      <button id="checkoutBtn">ZamÃ³w</button>
      <p id="checkoutMsg"></p>
    </section>
  </main>

  <script>
    const API = "/api";

    async function loadProducts() {
      const res = await fetch(`${API}/products`);
      const products = await res.json();
      const ul = document.getElementById("products");

      ul.innerHTML = "";
      products.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="prod-name">${p.name} â€“ ${p.price.toFixed(2)} zÅ‚</span>
          <button class="btn-add" data-id="${p.id}">+</button>
        `;
        ul.appendChild(li);
        li.querySelector("button").addEventListener("click", async () => {
          await fetch(`${API}/cart/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ product_id: p.id, qty: 1 })
          });
          loadCart();
        });
      });
    }

    async function loadCart() {
      const res = await fetch(`${API}/cart`);
      const data = await res.json();

      const body = document.getElementById("cartBody");
      body.innerHTML = "";

      data.items.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.product.name}</td>
          <td>${item.product.price.toFixed(2)} zÅ‚</td>
          <td>
            <input type="number" min="1" value="${item.qty}" data-id="${item.product.id}" />
          </td>
          <td><button class="btn-remove" data-id="${item.product.id}">X</button></td>
        `;
        body.appendChild(tr);

        tr.querySelector("input").addEventListener("change", async e => {
          await fetch(`${API}/cart/item`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              product_id: item.product.id,
              qty: e.target.value
            })
          });
          loadCart();
        });

        tr.querySelector("button").addEventListener("click", async e => {
          await fetch(`${API}/cart/item/${item.product.id}`, { method: "DELETE" });
          loadCart();
        });
      });

      document.getElementById("cartTotal").textContent =
        `Razem: ${data.total.toFixed(2)} zÅ‚`;
    }

    document.getElementById("checkoutBtn").addEventListener("click", async () => {
      const res = await fetch(`${API}/checkout`, { method: "POST" });
      const msg = document.getElementById("checkoutMsg");
      const data = await res.json();

      if (res.status === 201) {
        msg.textContent = `ZamÃ³wienie #${data.order_id} utworzone. Kwota: ${data.total.toFixed(2)} zÅ‚`;
        loadCart();
      } else {
        msg.textContent = `BÅ‚Ä…d: ${data.error}`;
      }
    });

    loadProducts();
    loadCart();
  </script>
</body>
</html>
